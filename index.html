<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kingshot Multi-Calculator</title>

<style>
:root {
  --primary-bg:#1e1e2f;
  --secondary-bg:#2a2a40;
  --card-bg:#2f2f48;
  --text-color:#ffffff;
  --accent-color:#f5a623;
  --warn-color:#ff4c4c;
}

body {
  font-family: Arial, sans-serif;
  background: var(--primary-bg);
  padding: 20px;
  color: var(--text-color);
}

h1,h2,h3 { text-align:center; color:var(--accent-color); }

.container {
  max-width:800px;
  margin:auto;
  background:var(--secondary-bg);
  padding:20px;
  border-radius:8px;
}

.row {
  display:flex;
  align-items:center;
  margin-bottom:10px;
}

label { flex:1; font-weight:bold; }
input,select,button {
  flex:2;
  padding:8px;
  margin-left:10px;
  border-radius:4px;
  border:none;
}

input,select { background:#444466; color:#fff; }
button { cursor:pointer; font-weight:bold; }

#addUpgrade { background:var(--accent-color); color:#1e1e2f; }
#resetBtn { background:var(--warn-color); color:#fff; margin-left:10px; }

.log { margin-top:15px; }

.upgrade-card {
  position:relative;
  background:linear-gradient(180deg,#2b2f4a,#1f2238);
  border:1px solid var(--accent-color);
  border-radius:10px;
  padding:14px 18px 14px 44px;
  margin-bottom:14px;
}

.upgrade-card h4 {
  margin:0 0 6px 0;
  color:var(--accent-color);
}

.upgrade-section {
  margin-top:6px;
  padding-top:6px;
  border-top:1px dashed rgba(245,166,35,0.4);
}

.delete-btn {
  position:absolute;
  left:14px;
  top:14px;
  width:22px;
  height:22px;
  border-radius:50%;
  background:rgba(0,0,0,0.6);
  color:#ff6b6b;
  font-size:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}

.delete-btn:hover {
  background:#ff4c4c;
  color:#fff;
}

.warn { color:var(--warn-color); font-weight:bold; }
.error { color:var(--warn-color); font-weight:bold; margin-top:10px; }
</style>
</head>

<body>

<h1>Kingshot Multi-Calculator</h1>

<div class="container">

<h2>Select Calculator</h2>
<div class="row">
  <label>Calculator</label>
  <select id="calculatorSelect">
    <option value="gov">Governor Gear</option>
    <option value="charm">Charm</option>
    <option value="forgehammer">Forgehammer</option>
  </select>
</div>

<h3>Starting Materials</h3>
<div class="row"><label id="matLabel1">Material 1</label><input type="number" id="currentMat1"></div>
<div class="row"><label id="matLabel2">Material 2</label><input type="number" id="currentMat2"></div>
<div class="row" id="matRow3"><label id="matLabel3">Material 3</label><input type="number" id="currentMat3"></div>

<h3>Select Tier/Level</h3>
<div class="row"><label>Tier</label><select id="tierSelect"></select></div>

<button id="addUpgrade" onclick="addUpgrade()">Add Upgrade</button>
<button id="resetBtn" onclick="resetAll()">Reset</button>

<div id="error" class="error"></div>
<div class="log" id="upgradeLog"></div>

<h3>Remaining Materials</h3>
<div class="upgrade-card"><div id="remainingDisplay"></div></div>

</div>

<script>
const API_BASE="https://sheetdb.io/api/v1/uhbk5p3hj3hh8";
let tiersData=[], upgrades=[], remaining=null;

const normalize=s=>String(s).toLowerCase().replace(/\s+/g,'');

function getApiUrl(calc){
  if(calc==='gov') return `${API_BASE}?sheet=Gov Gear Material Cost`;
  if(calc==='charm') return `${API_BASE}?sheet=Charm Upgrade Cost`;
  return `${API_BASE}?sheet=Forgehammer Cost`;
}

function updateMaterialLabels(calc){
  if(calc==='gov'){
    matLabel1.textContent='Satin';
    matLabel2.textContent='Threads';
    matLabel3.textContent='Artisans';
    matRow3.style.display='flex';
  } else if(calc==='charm'){
    matLabel1.textContent='Guides';
    matLabel2.textContent='Designs';
    matRow3.style.display='none';
  } else {
    matLabel1.textContent='Hammer';
    matLabel2.textContent='Mythic Gear';
    matRow3.style.display='none';
  }
}

async function loadTierCosts(){
  const calc=calculatorSelect.value;
  updateMaterialLabels(calc);
  tierSelect.innerHTML='';
  error.textContent='';

  try{
    const res=await fetch(getApiUrl(calc));
    const data=await res.json();
    if(!data.length) return;

    const headers=Object.keys(data[0]);
    const tierKey=headers.find(h=>normalize(h).includes('tier')||normalize(h).includes('level'));
    const mats=headers.filter(h=>h!==tierKey).slice(0,calc==='gov'?3:2);

    tiersData=data.filter(r=>r[tierKey]).map(r=>({
      tier:r[tierKey],
      mat1:+String(r[mats[0]]).replace(/,/g,'')||0,
      mat2:+String(r[mats[1]]).replace(/,/g,'')||0,
      mat3:calc==='gov'?+String(r[mats[2]]).replace(/,/g,'')||0:0
    }));

    tiersData.forEach(t=>{
      const opt=document.createElement('option');
      opt.value=t.tier;

      const i1=matLabel1.textContent.charAt(0);
      const i2=matLabel2.textContent.charAt(0);

      opt.textContent =
        calc==='gov'
          ? `${t.tier} (${i1}:${t.mat1} ${i2}:${t.mat2} A:${t.mat3})`
          : `${t.tier} (${i1}:${t.mat1} ${i2}:${t.mat2})`;

      tierSelect.appendChild(opt);
    });

    resetAll();
  } catch(e){
    error.textContent=e.message;
  }
}

function recalcRemaining(){
  remaining={
    mat1:+currentMat1.value||0,
    mat2:+currentMat2.value||0,
    mat3:calculatorSelect.value==='gov'?+currentMat3.value||0:0
  };
  upgrades.forEach(u=>{
    remaining.mat1-=u.tier.mat1;
    remaining.mat2-=u.tier.mat2;
    if(calculatorSelect.value==='gov') remaining.mat3-=u.tier.mat3;
  });
}

function renderRemaining(){
  if(!remaining) return;
  remainingDisplay.innerHTML =
    calculatorSelect.value==='gov'
      ? `<span class="warn">${matLabel1.textContent}: ${remaining.mat1} | ${matLabel2.textContent}: ${remaining.mat2} | ${matLabel3.textContent}: ${remaining.mat3}</span>`
      : `<span class="warn">${matLabel1.textContent}: ${remaining.mat1} | ${matLabel2.textContent}: ${remaining.mat2}</span>`;
}

function addUpgrade(){
  const tier=tiersData.find(t=>t.tier===tierSelect.value);
  if(!tier) return;

  const id=Date.now();
  upgrades.push({id,tier});

  recalcRemaining();
  renderRemaining();

  const card=document.createElement('div');
  card.className='upgrade-card';
  card.dataset.id=id;

  const del=document.createElement('span');
  del.className='delete-btn';
  del.textContent='⛔';
  del.onclick=()=>removeUpgrade(id);

  const title=document.createElement('h4');
  title.textContent=`Upgrade — ${tier.tier}`;

  const section=document.createElement('div');
  section.className='upgrade-section';
  section.textContent =
    `${matLabel1.textContent}: ${tier.mat1} | ${matLabel2.textContent}: ${tier.mat2}` +
    (calculatorSelect.value==='gov'
      ? ` | ${matLabel3.textContent}: ${tier.mat3}`
      : '');

  card.appendChild(del);
  card.appendChild(title);
  card.appendChild(section);

  upgradeLog.appendChild(card);
}

function removeUpgrade(id){
  upgrades=upgrades.filter(u=>u.id!==id);
  const el=upgradeLog.querySelector(`[data-id="${id}"]`);
  if(el) el.remove();
  recalcRemaining();
  renderRemaining();
}

function resetAll(){
  upgrades=[];
  upgradeLog.innerHTML='';
  remaining=null;
  remainingDisplay.innerHTML='';
  currentMat1.value='';
  currentMat2.value='';
  currentMat3.value='';
  if(tierSelect.options.length) tierSelect.selectedIndex=0;
}

calculatorSelect.addEventListener('change',loadTierCosts);
loadTierCosts();
</script>

</body>
</html>
