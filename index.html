<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kingshot Multi-Calculator</title>
<style>
  /* Color palette inspired by Kingshot Forgehammer calculator */
  :root {
    --primary-bg: #1e1e2f;
    --secondary-bg: #2a2a40;
    --card-bg: #2f2f48;
    --text-color: #ffffff;
    --accent-color: #f5a623;
    --warn-color: #ff4c4c;
    --button-bg: #f5a623;
    --button-text: #1e1e2f;
    --delete-color: #ff4c4c;
  }

  body { font-family: Arial, sans-serif; background: var(--primary-bg); padding: 20px; color: var(--text-color); }
  h1, h2 { text-align: center; color: var(--accent-color); }
  .container { max-width: 800px; margin: auto; background: var(--secondary-bg); padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,.5); }
  .row { display: flex; align-items: center; margin-bottom: 10px; }
  label { flex: 1; font-weight: bold; }
  input, select, button { flex: 2; padding: 8px; margin-left: 10px; border-radius: 4px; border: none; }
  input, select { background: #444466; color: var(--text-color); }
  button { cursor: pointer; font-weight: bold; }
  button#addUpgrade { background: var(--button-bg); color: var(--button-text); }
  button#resetBtn { background: var(--delete-color); color: var(--text-color); margin-left: 10px; }
  .log { margin-top: 15px; background: var(--card-bg); padding: 10px; border-radius: 6px; max-height: 220px; overflow-y: auto; }
  .log-entry { border-bottom: 1px solid #555577; padding: 6px 0; position: relative; padding-left: 30px; }
  .log-entry:last-child { border-bottom: none; }
  .delete-btn { position: absolute; left: 0; top: 0; cursor: pointer; color: var(--delete-color); font-weight: bold; width: 25px; text-align: center; }
  .warn { color: var(--warn-color); font-weight: bold; }
  .error { color: var(--warn-color); font-weight: bold; margin-top: 10px; }
  select option { background: var(--secondary-bg); color: var(--text-color); }
</style>
</head>
<body>

<h1>Kingshot Multi-Calculator</h1>
<div class="container">
  <h2>Select Calculator</h2>
  <div class="row">
    <label>Calculator</label>
    <select id="calculatorSelect">
      <option value="gov">Governor Gear</option>
      <option value="charm">Charm</option>
      <option value="forgehammer">Forgehammer</option>
    </select>
  </div>

  <h3>Starting Materials</h3>
  <div class="row"><label id="matLabel1">Material 1</label><input type="number" id="currentMat1" min="0"></div>
  <div class="row"><label id="matLabel2">Material 2</label><input type="number" id="currentMat2" min="0"></div>
  <div class="row" id="matRow3"><label id="matLabel3">Artisans</label><input type="number" id="currentMat3" min="0"></div>

  <h3>Add Upgrade</h3>
  <div class="row"><label>Tier</label><select id="tierSelect"><option>Loading…</option></select></div>

  <button id="addUpgrade" onclick="addUpgrade()">Add Upgrade</button>
  <button id="resetBtn" onclick="resetAll()">Reset</button>

  <div id="error" class="error"></div>
  <div class="log" id="upgradeLog"></div>

  <h3>Remaining Materials</h3>
  <div id="remainingDisplay"></div>
</div>

<script>
const API_BASE = "https://sheetdb.io/api/v1/uhbk5p3hj3hh8";
let tiersData = [];
let remaining = null;
let upgrades = [];

const normalize = s => String(s).toLowerCase().replace(/\s+/g,'');

function getApiUrlForCalculator(calc) {
  switch(calc) {
    case 'gov': return `${API_BASE}?sheet=Gov Gear Material Cost`;
    case 'charm': return `${API_BASE}?sheet=Charm Upgrade Cost`;
    case 'forgehammer': return `${API_BASE}?sheet=Forgehammer Cost`;
  }
}

function updateMaterialLabels(calc) {
  let labels;
  switch(calc) {
    case 'gov': labels = ['Satin','Threads','Artisans']; document.getElementById('matRow3').style.display='flex'; break;
    case 'charm': labels = ['Guide','Design']; document.getElementById('matRow3').style.display='none'; break;
    case 'forgehammer': labels = ['Hammer','Mythic Gear']; document.getElementById('matRow3').style.display='none'; break;
  }
  document.getElementById('matLabel1').textContent = labels[0];
  document.getElementById('matLabel2').textContent = labels[1];
}

async function loadTierCosts() {
  const calc = document.getElementById('calculatorSelect').value;
  const url = getApiUrlForCalculator(calc);
  const select = document.getElementById('tierSelect');
  select.innerHTML = '<option>Loading…</option>';
  document.getElementById('error').textContent = '';
  updateMaterialLabels(calc);

  try {
    const res = await fetch(url);
    const data = await res.json();
    if(!Array.isArray(data) || data.length===0) { select.innerHTML = '<option>No tiers available</option>'; return; }

    const headerMap = Object.keys(data[0]).map(k=>({raw:k, norm:normalize(k)}));
    const tierKey = headerMap.find(h=>h.norm.includes('tier') || h.norm.includes('level'))?.raw;
    let matKeys;
    if(calc==='gov'){ matKeys = headerMap.slice(1,4).map(h => h.raw); }
    else{ matKeys = headerMap.slice(1,3).map(h => h.raw); }

    if(!tierKey || matKeys.length<2){
      throw new Error(`Sheet invalid format. Detected columns: ${Object.keys(data[0]).join(', ')}`);
    }

    tiersData = data.filter(r=>r[tierKey]).map(r=>{
      let tierObj={ tier: r[tierKey], mat1: Number(String(r[matKeys[0]]).replace(/,/g,'')) || 0, mat2: Number(String(r[matKeys[1]]).replace(/,/g,'')) || 0 };
      if(calc==='gov'){ tierObj.mat3 = Number(String(r[matKeys[2]]).replace(/,/g,'')) || 0; }
      return tierObj;
    });

    select.innerHTML = '';
    if(tiersData.length===0){select.innerHTML='<option>No tiers available</option>'; return;}

    tiersData.forEach(t=>{
      const opt=document.createElement('option');
      opt.value=t.tier;
      let init1 = document.getElementById('matLabel1').textContent.charAt(0);
      let init2 = document.getElementById('matLabel2').textContent.charAt(0);
      let displayText = calc==='gov' ? `(${init1}:${t.mat1} ${init2}:${t.mat2} A:${t.mat3})` : `(${init1}:${t.mat1} ${init2}:${t.mat2})`;
      opt.textContent=`${t.tier} ${displayText}`;
      select.appendChild(opt);
    });

    resetAll();

  } catch(e){
    select.innerHTML = '<option>Error loading tiers</option>';
    document.getElementById('error').textContent = e.message;
    console.error(e);
  }
}

function addUpgrade(){
  const mat1Input = Number(document.getElementById('currentMat1').value);
  const mat2Input = Number(document.getElementById('currentMat2').value);
  const mat3Input = Number(document.getElementById('currentMat3').value);

  const tierName = document.getElementById('tierSelect').value;
  const tier = tiersData.find(t=>t.tier===tierName);
  if(!tier) return;

  const upgradeId = Date.now();
  upgrades.push({id: upgradeId, tier});

  remaining = { mat1: mat1Input, mat2: mat2Input, mat3: document.getElementById('calculatorSelect').value==='gov' ? mat3Input : 0 };
  upgrades.forEach(u=>{
    remaining.mat1 -= u.tier.mat1;
    remaining.mat2 -= u.tier.mat2;
    if(document.getElementById('calculatorSelect').value==='gov'){ remaining.mat3 -= u.tier.mat3; }
  });

  updateRemainingDisplay();

  const logDiv = document.getElementById('upgradeLog');
  const logEntry = document.createElement('div');
  logEntry.className='log-entry';
  logEntry.dataset.id = upgradeId;

  const deleteBtn = document.createElement('span');
  deleteBtn.className = 'delete-btn';
  deleteBtn.textContent = '⛔';
  deleteBtn.onclick = () => removeUpgrade(upgradeId);
  logEntry.appendChild(deleteBtn);

  const upgradeText = document.createElement('div');
  let init1 = document.getElementById('matLabel1').textContent.charAt(0);
  let init2 = document.getElementById('matLabel2').textContent.charAt(0);
  let costText = document.getElementById('calculatorSelect').value==='gov' ? `${init1} ${tier.mat1}, ${init2} ${tier.mat2}, Artisans ${tier.mat3}` : `${init1} ${tier.mat1}, ${init2} ${tier.mat2}`;
  let remainingText = document.getElementById('calculatorSelect').value==='gov' ? `${document.getElementById('matLabel1').textContent} ${remaining.mat1}, ${document.getElementById('matLabel2').textContent} ${remaining.mat2}, ${document.getElementById('matLabel3').textContent} ${remaining.mat3}` : `${document.getElementById('matLabel1').textContent} ${remaining.mat1}, ${document.getElementById('matLabel2').textContent} ${remaining.mat2}`;
  upgradeText.innerHTML = `<strong>Upgrade — ${tier.tier}</strong><br>Cost: ${costText}<br><span class='warn'>Remaining: ${remainingText}</span>`;
  logEntry.appendChild(upgradeText);

  logDiv.appendChild(logEntry);
}

function removeUpgrade(upgradeId){
  upgrades = upgrades.filter(u=>u.id!==upgradeId);
  const mat1Input = Number(document.getElementById('currentMat1').value);
  const mat2Input = Number(document.getElementById('currentMat2').value);
  const mat3Input = Number(document.getElementById('currentMat3').value);
  remaining = { mat1: mat1Input, mat2: mat2Input, mat3: document.getElementById('calculatorSelect').value==='gov' ? mat3Input : 0 };
  upgrades.forEach(u=>{
    remaining.mat1 -= u.tier.mat1;
    remaining.mat2 -= u.tier.mat2;
    if(document.getElementById('calculatorSelect').value==='gov'){ remaining.mat3 -= u.tier.mat3; }
  });
  updateRemainingDisplay();
  const logDiv = document.getElementById('upgradeLog');
  const logEntry = logDiv.querySelector(`.log-entry[data-id='${upgradeId}']`);
  if(logEntry) logDiv.removeChild(logEntry);
}

function updateRemainingDisplay(){
  if(!remaining) return;
  let calc = document.getElementById('calculatorSelect').value;
  if(calc==='gov'){
    document.getElementById('remainingDisplay').innerHTML=`${document.getElementById('matLabel1').textContent}: <strong>${remaining.mat1}</strong><br>${document.getElementById('matLabel2').textContent}: <strong>${remaining.mat2}</strong><br>${document.getElementById('matLabel3').textContent}: <strong>${remaining.mat3}</strong>`;
  } else {
    document.getElementById('remainingDisplay').innerHTML=`${document.getElementById('matLabel1').textContent}: <strong>${remaining.mat1}</strong><br>${document.getElementById('matLabel2').textContent}: <strong>${remaining.mat2}</strong>`;
  }
}

function resetAll(){
  upgrades = [];
  remaining=null;
  document.getElementById('upgradeLog').innerHTML='';
  document.getElementById('remainingDisplay').innerHTML='';
  document.getElementById('currentMat1').value='';
  document.getElementById('currentMat2').value='';
  document.getElementById('currentMat3').value='';
  if(tiersData.length>0) document.getElementById('tierSelect').value = tiersData[0].tier;
}

document.getElementById('calculatorSelect').addEventListener('change',()=>{ loadTierCosts(); });
loadTierCosts();
</script>
</body>
</html>
